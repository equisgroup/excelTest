Option Explicit

' ========================================
' M√ìDULO PRINCIPAL - ACTUALIZACI√ìN DE DASHBOARD
' ========================================

Sub ActualizarDashboardYConflictos()
    On Error GoTo ErrorHandler
    
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    ' Mostrar progreso
    Application.StatusBar = "Actualizando columnas de conflictos..."
    
    ' 1. Actualizar columnas de conflictos en Vacaciones
    Call ActualizarConflictosVacaciones
    
    ' 2. Actualizar columnas de conflictos en Viajes
    Application.StatusBar = "Actualizando conflictos de viajes..."
    Call ActualizarConflictosViajes
    
    ' 3. Actualizar columnas de conflictos en Asignaciones
    Application.StatusBar = "Actualizando conflictos de asignaciones..."
    Call ActualizarConflictosAsignaciones
    
    ' 4. Recalcular todas las f√≥rmulas
    Application.StatusBar = "Recalculando f√≥rmulas..."
    Application.Calculation = xlCalculationAutomatic
    Application.Calculate
    
    ' 5. Actualizar hoja de Alertas y Conflictos
    Application.StatusBar = "Actualizando hoja de alertas..."
    Call ActualizarHojaAlertas
    
    Application.ScreenUpdating = True
    Application.StatusBar = False
    
    MsgBox "‚úÖ Actualizaci√≥n completada exitosamente!" & vbCrLf & vbCrLf & _
           "- Conflictos detectados y actualizados" & vbCrLf & _
           "- Dashboard recalculado" & vbCrLf & _
           "- Alertas actualizadas", vbInformation, "Actualizaci√≥n Completa"
    
    Exit Sub
    
ErrorHandler:
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.StatusBar = False
    MsgBox "‚ùå Error al actualizar: " & Err.Description, vbCritical, "Error"
End Sub

Private Sub ActualizarConflictosVacaciones()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    
    On Error Resume Next
    Set ws = ThisWorkbook.Worksheets("üèñÔ∏è Vacaciones")
    If ws Is Nothing Then Exit Sub
    On Error GoTo 0
    
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    ' Asegurar que las columnas de conflictos existen y tienen f√≥rmulas
    For i = 2 To lastRow
        ' Columna G: Conflictos Viajes
        If Len(ws.Cells(i, 7).Formula) = 0 Then
            ws.Cells(i, 7).Formula = "=SUMPRODUCT(('‚úàÔ∏è Viajes'!$B:$B=B" & i & ")*('‚úàÔ∏è Viajes'!$F:$F<=D" & i & ")*('‚úàÔ∏è Viajes'!$G:$G>=C" & i & "))"
        End If
        
        ' Columna H: Conflictos Soporte
        If Len(ws.Cells(i, 8).Formula) = 0 Then
            ws.Cells(i, 8).Formula = "=SUMPRODUCT(('üõ†Ô∏è Turnos Soporte'!$B:$B=B" & i & ")*('üõ†Ô∏è Turnos Soporte'!$C:$C<=D" & i & ")*('üõ†Ô∏è Turnos Soporte'!$D:$D>=C" & i & "))"
        End If
        
        ' Columna I: Feriados Empleado
        If Len(ws.Cells(i, 9).Formula) = 0 Then
            ws.Cells(i, 9).Formula = "=COUNTIFS('üìÖ Feriados'!$D:$D,"">=""&C" & i & ",'üìÖ Feriados'!$D:$D,""<=""&D" & i & ")"
        End If
        
        ' Columna J: Feriados Cliente
        If Len(ws.Cells(i, 10).Formula) = 0 Then
            ws.Cells(i, 10).Formula = "=COUNTIFS('üìÖ Feriados'!$D:$D,"">=""&C" & i & ",'üìÖ Feriados'!$D:$D,""<=""&D" & i & ")"
        End If
    Next i
End Sub

Private Sub ActualizarConflictosViajes()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    
    On Error Resume Next
    Set ws = ThisWorkbook.Worksheets("‚úàÔ∏è Viajes")
    If ws Is Nothing Then Exit Sub
    On Error GoTo 0
    
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    For i = 2 To lastRow
        ' Columna K: Feriados Destino
        If Len(ws.Cells(i, 11).Formula) = 0 Then
            ws.Cells(i, 11).Formula = "=COUNTIFS('üìÖ Feriados'!$B:$B,D" & i & ",'üìÖ Feriados'!$D:$D,"">=""&F" & i & ",'üìÖ Feriados'!$D:$D,""<=""&G" & i & ")"
        End If
        
        ' Columna L: Feriados Empleado
        If Len(ws.Cells(i, 12).Formula) = 0 Then
            ws.Cells(i, 12).Formula = "=COUNTIFS('üìÖ Feriados'!$D:$D,"">=""&F" & i & ",'üìÖ Feriados'!$D:$D,""<=""&G" & i & ")"
        End If
        
        ' Columna M: Conflictos Soporte
        If Len(ws.Cells(i, 13).Formula) = 0 Then
            ws.Cells(i, 13).Formula = "=SUMPRODUCT(('üõ†Ô∏è Turnos Soporte'!$B:$B=B" & i & ")*('üõ†Ô∏è Turnos Soporte'!$C:$C<=G" & i & ")*('üõ†Ô∏è Turnos Soporte'!$D:$D>=F" & i & "))"
        End If
    Next i
End Sub

Private Sub ActualizarConflictosAsignaciones()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    
    On Error Resume Next
    Set ws = ThisWorkbook.Worksheets("üîÑ Asignaciones")
    If ws Is Nothing Then Exit Sub
    On Error GoTo 0
    
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    For i = 2 To lastRow
        ' Columna H: Conflictos Vacaciones
        If Len(ws.Cells(i, 8).Formula) = 0 Then
            ws.Cells(i, 8).Formula = "=SUMPRODUCT(('üèñÔ∏è Vacaciones'!$B:$B=B" & i & ")*('üèñÔ∏è Vacaciones'!$C:$C<=E" & i & ")*('üèñÔ∏è Vacaciones'!$D:$D>=D" & i & "))"
        End If
        
        ' Columna I: Conflictos Viajes
        If Len(ws.Cells(i, 9).Formula) = 0 Then
            ws.Cells(i, 9).Formula = "=SUMPRODUCT(('‚úàÔ∏è Viajes'!$B:$B=B" & i & ")*('‚úàÔ∏è Viajes'!$F:$F<=E" & i & ")*('‚úàÔ∏è Viajes'!$G:$G>=D" & i & "))"
        End If
        
        ' Columna J: Feriados Empleado
        If Len(ws.Cells(i, 10).Formula) = 0 Then
            ws.Cells(i, 10).Formula = "=COUNTIFS('üìÖ Feriados'!$D:$D,"">=""&D" & i & ",'üìÖ Feriados'!$D:$D,""<=""&E" & i & ")"
        End If
        
        ' Columna K: Feriados Cliente
        If Len(ws.Cells(i, 11).Formula) = 0 Then
            ws.Cells(i, 11).Formula = "=COUNTIFS('üìÖ Feriados'!$D:$D,"">=""&D" & i & ",'üìÖ Feriados'!$D:$D,""<=""&E" & i & ")"
        End If
    Next i
End Sub

Private Sub ActualizarHojaAlertas()
    Dim ws As Worksheet
    
    On Error Resume Next
    Set ws = ThisWorkbook.Worksheets("üö® Alertas y Conflictos")
    If ws Is Nothing Then Exit Sub
    On Error GoTo 0
    
    ' Simplemente recalcular la hoja
    ws.Calculate
End Sub

